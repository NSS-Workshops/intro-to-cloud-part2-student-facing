name: Deploy

on:
  push:
    branches: [ main, tr-intital-setup ]

permissions:
  contents: read
  pages: write
  id-token: write
  packages: read
  actions: read     # <-- needed to read workflow runs/jobs
  checks: read      # <-- needed to read check runs
  statuses: read    # <-- needed to read commit statuses
  pull-requests: write
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Skip deployment if this is the template repository
    if: github.event.repository.name != 'curriculum-site-template'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@nss-workshops'
      env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Create env file
      run: |
          echo "VITE_LEARNING_PLATFORM_API=https://learningapi.nss.team" >> .env
    - name: Install dependencies
      run: npm ci
    
    - name: Check if doAuth is enabled
      id: check-auth
      run: |
        if grep -q "doAuth: true" src/config.js; then
          echo "auth_enabled=true" >> $GITHUB_OUTPUT
        else
          echo "auth_enabled=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Build without OAuth variables (if auth disabled)
      if: steps.check-auth.outputs.auth_enabled == 'false'
      run: npm run build
    
    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Notify Slack of Deployment
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        text: "Cloud Course deployment ${{ job.status }}"
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()